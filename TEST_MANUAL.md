# StudySpark 認証テストシステム - 動作確認手順書

## 前提条件

1. Supabase プロジェクトが作成済み
2. 環境変数（.env.local）が設定済み
3. データベースマイグレーションが実行済み（supabase/migrations/*.sql）
4. 開発サーバーが起動済み（`npm run dev`）

## 1. 初期セットアップ

### 1.1 環境変数の設定

`.env.local`ファイルに以下を設定：

```env
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### 1.2 データベースマイグレーション

Supabase ダッシュボードのSQL Editorで以下を実行：

1. `supabase/migrations/01_create_tables.sql`
2. `supabase/migrations/02_row_level_security.sql`

### 1.3 開発サーバーの起動

```bash
npm run dev
```

## 2. 保護者アカウントの動作確認

### 2.1 新規登録

1. http://localhost:3000/register にアクセス
2. 以下の情報で登録：
   - メールアドレス：test-parent@gmail.com（実際に受信可能なメール）
   - 表示名：テスト保護者
   - パスワード：TestPassword123!
3. 「アカウントを作成」ボタンをクリック
4. 確認メールが送信されることを確認

**期待される動作：**
- 成功メッセージ「確認メールを送信しました」が表示される
- メールボックスに確認メールが届く

### 2.2 メール確認

1. メールボックスの確認メール内のリンクをクリック
2. 自動的に `/dashboard` にリダイレクトされる

**期待される動作：**
- ダッシュボードが表示される
- メール確認ステータスが「確認済み」になる

### 2.3 ログイン

1. http://localhost:3000/login にアクセス
2. 登録したメール/パスワードでログイン
3. 「ログイン」ボタンをクリック

**期待される動作：**
- `/dashboard` にリダイレクトされる
- ユーザー情報が正しく表示される

### 2.4 ダッシュボード確認

ダッシュボードで以下を確認：

- **ユーザー情報**
  - 表示名
  - 役割（保護者）
  - メールアドレス
  - 家族ID（FAM-XXXXX形式）
  
- **セッション情報**
  - アカウント作成日
  - 最終ログイン
  - メール確認（確認済み）

- **家族構成**
  - 「まだ生徒が登録されていません」と表示

### 2.5 生徒アカウント追加（ダミー実装）

1. 家族構成セクションの「生徒を追加」ボタンをクリック
2. 以下の情報を入力：
   - ログインID：たろう2015
   - パスワード：1234
   - 姓：山田
   - 名：太郎
   - 姓（かな）：やまだ
   - 名（かな）：たろう
3. 「作成」ボタンをクリック

**期待される動作：**
- メッセージ「生徒アカウント作成機能は実装準備中です」が表示される
- （実際のSupabase Admin API実装後は生徒が作成される）

## 3. 生徒アカウントの動作確認

### 3.1 生徒ログイン（ダミー実装）

1. http://localhost:3000/student-login にアクセス
2. 以下の情報でログイン：
   - ログインID：たろう2015
   - パスワード：1234
3. 「ログイン」ボタンをクリック

**期待される動作：**
- エラーメッセージが表示される（実装準備中のため）
- （実際の実装後は `/student/dashboard` にリダイレクト）

## 4. メール移管機能の動作確認

### 4.1 移管申請

1. 保護者アカウントでログイン
2. ナビゲーションの「メール移管」をクリック
3. 以下を入力：
   - 新しいメールアドレス：new-email@example.com
   - 新しいメールアドレス（確認）：new-email@example.com
   - 移管理由：Gmailエイリアスから実メールへの移行
4. 「移管を申請」ボタンをクリック

**期待される動作：**
- 成功メッセージ「移管申請を受け付けました」が表示される
- 移管履歴に「申請中」のステータスで表示される

### 4.2 移管ステータス確認

移管ページの右側パネルで確認：

- 申請日
- ステータス（申請中）
- 新しいメールアドレス

## 5. パスワードリセット機能

### 5.1 パスワードリセット申請

1. http://localhost:3000/reset-password にアクセス
2. 登録済みメールアドレスを入力
3. 「リセットメールを送信」ボタンをクリック

**期待される動作：**
- 成功メッセージが表示される
- パスワードリセット用メールが送信される

## 6. エラー処理の確認

### 6.1 認証なしアクセス

1. ログアウト状態で http://localhost:3000/dashboard にアクセス

**期待される動作：**
- `/login` にリダイレクトされる

### 6.2 不正なログイン

1. http://localhost:3000/login で間違ったパスワードを入力

**期待される動作：**
- エラーメッセージが表示される

### 6.3 重複登録

1. 既に登録済みのメールアドレスで新規登録を試みる

**期待される動作：**
- エラーメッセージが表示される

## 7. レスポンシブデザインの確認

### 7.1 モバイル表示

1. ブラウザのデベロッパーツールで モバイル表示に切り替え
2. 各ページのレイアウトが適切に調整されることを確認

**確認ポイント：**
- ナビゲーションメニュー
- フォーム要素
- カード・パネルの配置

## 8. セッション管理

### 8.1 セッションタイムアウト

1. ログイン後、長時間放置
2. 再度アクセスした際の動作を確認

**期待される動作：**
- セッションが有効な間はログイン状態が維持される
- セッション切れ後は再ログインが必要

### 8.2 複数デバイスログイン

1. 複数のブラウザで同じアカウントにログイン
2. 両方でダッシュボードアクセスを確認

**期待される動作：**
- 両方でログイン状態が維持される

## トラブルシューティング

### エラー: Supabase接続失敗

**原因：** 環境変数が正しく設定されていない
**対処：** `.env.local`の値を確認し、開発サーバーを再起動

### エラー: テーブルが見つからない

**原因：** データベースマイグレーションが実行されていない
**対処：** Supabase ダッシュボードでSQLを実行

### エラー: RLSポリシーエラー

**原因：** Row Level Securityが適切に設定されていない
**対処：** `02_row_level_security.sql`を再実行

## チェックリスト

- [ ] 保護者アカウント新規登録
- [ ] メール確認
- [ ] ログイン/ログアウト
- [ ] ダッシュボード表示
- [ ] 生徒アカウント追加（ダミー）
- [ ] メール移管申請
- [ ] パスワードリセット
- [ ] エラーハンドリング
- [ ] レスポンシブデザイン
- [ ] セッション管理

## 注意事項

- 本システムは認証機能の検証目的のテスト実装です
- 生徒アカウント作成とメール移管実行はダミー実装となっています
- 本番環境ではSupabase Admin APIの実装が必要です
- Gmailエイリアス機能を使用する場合は、実際のGmailアカウントでテストしてください

## 開発者向け情報

### ビルドコマンド

```bash
# 開発サーバー
npm run dev

# プロダクションビルド
npm run build

# プロダクションサーバー起動
npm run start

# Lintチェック
npm run lint
```

### ディレクトリ構造

```
src/
├── app/           # Next.js App Router
├── components/    # React Components
├── lib/          # Utility Functions
├── types/        # TypeScript Types
└── middleware.ts # Next.js Middleware
```

### 主要ファイル

- `src/lib/supabase/server.ts` - Server Component用Supabaseクライアント
- `src/lib/supabase/client.ts` - Client Component用Supabaseクライアント
- `src/lib/auth/actions.ts` - 認証関連のServer Actions
- `src/lib/auth/migration.ts` - メール移管関連のServer Actions