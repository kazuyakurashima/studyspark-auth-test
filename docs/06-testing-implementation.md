# 06. ãƒ†ã‚¹ãƒˆå®Ÿè£…

## æ¦‚è¦
èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å“è³ªæ‹…ä¿ã¨æ¤œè¨¼ã®ãŸã‚ã€åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚å˜ä½“ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã€E2Eãƒ†ã‚¹ãƒˆã‚’æ®µéšçš„ã«å®Ÿæ–½ã—ã¾ã™ã€‚

## å„ªå…ˆåº¦
ğŸ”¥ **é«˜** - ã‚·ã‚¹ãƒ†ãƒ å“è³ªä¿è¨¼ã®æ ¹å¹¹

## è¦‹ç©ã‚‚ã‚Šå·¥æ•°
**16æ™‚é–“**ï¼ˆ4æ—¥é–“ï¼‰

## å‰ææ¡ä»¶
- å…¨ã¦ã®æ©Ÿèƒ½å®Ÿè£…ãŒå®Œäº†ã—ã¦ã„ã‚‹
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹
- Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

## Todo ãƒªã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] Jest + Testing Library ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] Playwright E2E ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
- [ ] CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š

### å˜ä½“ãƒ†ã‚¹ãƒˆ (Jest)
- [ ] Server Actions ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] Client Components ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ãƒ†ã‚¹ãƒˆå®Ÿè£…

### çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œçµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¡ãƒ¼ãƒ«ç§»ç®¡ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ

### E2E ãƒ†ã‚¹ãƒˆ (Playwright)
- [ ] ä¿è­·è€…ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] ç”Ÿå¾’ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¡ãƒ¼ãƒ«ç§»ç®¡ãƒ†ã‚¹ãƒˆ
- [ ] ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] èªè¨¼å‡¦ç†ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] åŒæ™‚æ¥ç¶šãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- [ ] èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] RLS ãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆ
- [ ] SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] XSS è„†å¼±æ€§ãƒ†ã‚¹ãƒˆ

## å®Ÿè£…å†…å®¹

### 1. ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### package.json ãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚
```json
{
  "devDependencies": {
    "@testing-library/jest-dom": "^6.1.4",
    "@testing-library/react": "^13.4.0",
    "@testing-library/user-event": "^14.5.1",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "@playwright/test": "^1.40.0",
    "dotenv": "^16.3.1"
  },
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

#### jest.config.js
```javascript
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  testMatch: [
    '**/__tests__/**/*.(ts|tsx|js)',
    '**/*.(test|spec).(ts|tsx|js)'
  ],
  collectCoverageFrom: [
    'app/**/*.{js,jsx,ts,tsx}',
    'components/**/*.{js,jsx,ts,tsx}',
    'lib/**/*.{js,jsx,ts,tsx}',
    '!**/*.d.ts',
    '!**/node_modules/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}

module.exports = createJestConfig(customJestConfig)
```

#### jest.setup.js
```javascript
import '@testing-library/jest-dom'

// Supabase Auth ã®ãƒ¢ãƒƒã‚¯
jest.mock('@/lib/supabase/client', () => ({
  createClient: jest.fn(() => ({
    auth: {
      signInWithPassword: jest.fn(),
      signUp: jest.fn(),
      signOut: jest.fn(),
      getUser: jest.fn(),
    },
    from: jest.fn(() => ({
      select: jest.fn().mockReturnThis(),
      insert: jest.fn().mockReturnThis(),
      update: jest.fn().mockReturnThis(),
      eq: jest.fn().mockReturnThis(),
      single: jest.fn(),
    })),
  })),
}))

// Next.js router ã®ãƒ¢ãƒƒã‚¯
jest.mock('next/navigation', () => ({
  useRouter: () => ({
    push: jest.fn(),
    replace: jest.fn(),
    prefetch: jest.fn(),
  }),
  useSearchParams: () => ({
    get: jest.fn(),
  }),
  redirect: jest.fn(),
}))
```

### 2. Server Actions å˜ä½“ãƒ†ã‚¹ãƒˆ

#### __tests__/lib/auth/actions.test.ts
```typescript
import { signIn, signUp, signInStudent } from '@/lib/auth/actions'
import { createClient } from '@/lib/supabase/server'

jest.mock('@/lib/supabase/server')
jest.mock('next/navigation')

const mockSupabase = {
  auth: {
    signInWithPassword: jest.fn(),
    signUp: jest.fn(),
  },
  from: jest.fn(() => ({
    insert: jest.fn().mockResolvedValue({ error: null }),
  })),
}

;(createClient as jest.Mock).mockReturnValue(mockSupabase)

describe('Auth Actions', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  describe('signIn', () => {
    it('æ­£å¸¸ãªãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†', async () => {
      const formData = new FormData()
      formData.append('email', 'test@example.com')
      formData.append('password', 'password123')

      mockSupabase.auth.signInWithPassword.mockResolvedValue({
        error: null,
        data: { user: { id: '123', email: 'test@example.com' } }
      })

      const result = await signIn(formData)
      
      expect(mockSupabase.auth.signInWithPassword).toHaveBeenCalledWith({
        email: 'test@example.com',
        password: 'password123'
      })
      
      expect(result).toBeUndefined() // redirect ãŒå‘¼ã°ã‚Œã‚‹
    })

    it('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', async () => {
      const formData = new FormData()
      formData.append('email', 'invalid@example.com')
      formData.append('password', 'wrongpassword')

      mockSupabase.auth.signInWithPassword.mockResolvedValue({
        error: { message: 'Invalid credentials' }
      })

      const result = await signIn(formData)
      
      expect(result).toEqual({ error: 'Invalid credentials' })
    })
  })

  describe('signInStudent', () => {
    it('ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆä»®æƒ³ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›ï¼‰', async () => {
      const formData = new FormData()
      formData.append('loginId', 'ãŸã‚ã†2015')
      formData.append('password', 'pass123')

      mockSupabase.auth.signInWithPassword.mockResolvedValue({
        error: null,
        data: { user: { id: '456' } }
      })

      await signInStudent(formData)
      
      expect(mockSupabase.auth.signInWithPassword).toHaveBeenCalledWith({
        email: 'ãŸã‚ã†2015@studyspark.local',
        password: 'pass123'
      })
    })

    it('ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚', async () => {
      const formData = new FormData()
      formData.append('loginId', 'invalid')
      formData.append('password', 'wrong')

      mockSupabase.auth.signInWithPassword.mockResolvedValue({
        error: { message: 'Invalid login credentials' }
      })

      const result = await signInStudent(formData)
      
      expect(result).toEqual({ 
        error: 'ãƒ­ã‚°ã‚¤ãƒ³IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™' 
      })
    })
  })

  describe('signUp', () => {
    it('ä¿è­·è€…æ–°è¦ç™»éŒ²å‡¦ç†', async () => {
      const formData = new FormData()
      formData.append('email', 'parent@example.com')
      formData.append('password', 'securepass123')
      formData.append('displayName', 'å±±ç”°å¤ªéƒ')

      mockSupabase.auth.signUp.mockResolvedValue({
        error: null,
        data: { user: { id: '789', email: 'parent@example.com' } }
      })

      const result = await signUp(formData)
      
      expect(mockSupabase.auth.signUp).toHaveBeenCalledWith({
        email: 'parent@example.com',
        password: 'securepass123',
        options: {
          emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/api/auth/callback`,
          data: {
            display_name: 'å±±ç”°å¤ªéƒ',
            role: 'parent'
          }
        }
      })
      
      expect(result).toEqual({ 
        success: true, 
        message: 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ' 
      })
    })
  })
})
```

### 3. Client Components å˜ä½“ãƒ†ã‚¹ãƒˆ

#### __tests__/components/client/LoginForm.test.tsx
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { LoginForm } from '@/components/client/LoginForm'
import { signIn } from '@/lib/auth/actions'

jest.mock('@/lib/auth/actions')

describe('LoginForm', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  it('ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
    render(<LoginForm />)
    
    expect(screen.getByLabelText(/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰/i)).toBeInTheDocument()
    expect(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³/i })).toBeInTheDocument()
  })

  it('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹', async () => {
    const user = userEvent.setup()
    ;(signIn as jest.Mock).mockResolvedValue({})
    
    render(<LoginForm />)
    
    await user.type(screen.getByLabelText(/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/i), 'test@example.com')
    await user.type(screen.getByLabelText(/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰/i), 'password123')
    await user.click(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³/i }))
    
    await waitFor(() => {
      expect(signIn).toHaveBeenCalled()
    })
  })

  it('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
    const user = userEvent.setup()
    ;(signIn as jest.Mock).mockResolvedValue({ 
      error: 'Invalid credentials' 
    })
    
    render(<LoginForm />)
    
    await user.type(screen.getByLabelText(/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/i), 'invalid@example.com')
    await user.type(screen.getByLabelText(/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰/i), 'wrongpassword')
    await user.click(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³/i }))
    
    await waitFor(() => {
      expect(screen.getByText('Invalid credentials')).toBeInTheDocument()
    })
  })

  it('é€ä¿¡ä¸­ã¯é©åˆ‡ãªçŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
    const user = userEvent.setup()
    let resolveSignIn: () => void
    const signInPromise = new Promise<void>((resolve) => {
      resolveSignIn = resolve
    })
    ;(signIn as jest.Mock).mockReturnValue(signInPromise)
    
    render(<LoginForm />)
    
    await user.type(screen.getByLabelText(/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/i), 'test@example.com')
    await user.type(screen.getByLabelText(/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰/i), 'password123')
    await user.click(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³/i }))
    
    // é€ä¿¡ä¸­ã®çŠ¶æ…‹ç¢ºèª
    expect(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³ä¸­/i })).toBeDisabled()
    
    // é€ä¿¡å®Œäº†
    resolveSignIn!()
    await waitFor(() => {
      expect(screen.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³/i })).not.toBeDisabled()
    })
  })
})
```

### 4. E2E ãƒ†ã‚¹ãƒˆ (Playwright)

#### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

#### e2e/auth-flow.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('èªè¨¼ãƒ•ãƒ­ãƒ¼', () => {
  test.beforeEach(async ({ page }) => {
    // ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    await page.goto('/api/test/cleanup')
  })

  test('ä¿è­·è€…ã®æ–°è¦ç™»éŒ²ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã¾ã§', async ({ page }) => {
    // æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸
    await page.goto('/register')
    
    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
    await page.fill('input[name="email"]', 'test-parent@example.com')
    await page.fill('input[name="password"]', 'SecurePass123!')
    await page.fill('input[name="displayName"]', 'ãƒ†ã‚¹ãƒˆä¿è­·è€…')
    
    // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    await page.click('button[type="submit"]')
    
    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç¢ºèª
    await expect(page.locator('text=ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ')).toBeVisible()
    
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯è‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹
    await page.goto('/api/test/verify-email?email=test-parent@example.com')
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
    await page.goto('/login')
    
    // ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    await page.fill('input[name="email"]', 'test-parent@example.com')
    await page.fill('input[name="password"]', 'SecurePass123!')
    await page.click('button[type="submit"]')
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page).toHaveURL('/dashboard')
    await expect(page.locator('h1:has-text("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")')).toBeVisible()
  })

  test('ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½', async ({ page }) => {
    // äº‹å‰ã«ä¿è­·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ç”Ÿå¾’ã‚’ä½œæˆ
    await page.goto('/api/test/setup-student?loginId=testuser001&password=pass123')
    
    // ç”Ÿå¾’ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
    await page.goto('/student-login')
    
    // ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    await page.fill('input[name="loginId"]', 'testuser001')
    await page.fill('input[name="password"]', 'pass123')
    await page.click('button[type="submit"]')
    
    // ç”Ÿå¾’ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    await expect(page).toHaveURL('/student/dashboard')
    await expect(page.locator('text=testuser001')).toBeVisible()
  })

  test('ç„¡åŠ¹ãªèªè¨¼æƒ…å ±ã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ', async ({ page }) => {
    await page.goto('/login')
    
    await page.fill('input[name="email"]', 'invalid@example.com')
    await page.fill('input[name="password"]', 'wrongpassword')
    await page.click('button[type="submit"]')
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç¢ºèª
    await expect(page.locator('text=Invalid login credentials')).toBeVisible()
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç•™ã¾ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page).toHaveURL('/login')
  })

  test('èªè¨¼ã‚¬ãƒ¼ãƒ‰ã®å‹•ä½œç¢ºèª', async ({ page }) => {
    // æœªèªè¨¼çŠ¶æ…‹ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/dashboard')
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page).toHaveURL('/login')
  })
})
```

#### e2e/migration-flow.spec.ts
```typescript
import { test, expect } from '@playwright/test'

test.describe('ãƒ¡ãƒ¼ãƒ«ç§»ç®¡ãƒ•ãƒ­ãƒ¼', () => {
  test('ä¿è­·è€…ã«ã‚ˆã‚‹ç§»ç®¡ç”³è«‹ã‹ã‚‰å®Ÿè¡Œã¾ã§', async ({ page }) => {
    // ä¿è­·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('/api/test/create-parent?email=parent@example.com')
    await page.goto('/login')
    await page.fill('input[name="email"]', 'parent@example.com')
    await page.fill('input[name="password"]', 'TestPass123!')
    await page.click('button[type="submit"]')
    
    // ç§»ç®¡ãƒšãƒ¼ã‚¸ã¸
    await page.goto('/migration')
    
    // ç§»ç®¡ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
    await page.fill('input[name="newEmail"]', 'new-parent@example.com')
    await page.fill('textarea[name="reason"]', 'å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ã—ãŸã„ãŸã‚')
    await page.click('button[type="submit"]:has-text("ç§»ç®¡ç”³è«‹ã‚’é€ä¿¡")')
    
    // ç”³è«‹å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
    await expect(page.locator('text=ç§»ç®¡ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ')).toBeVisible()
    
    // ç®¡ç†è€…ã§ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('/api/test/create-admin')
    await page.goto('/login')
    await page.fill('input[name="email"]', 'admin@example.com')
    await page.fill('input[name="password"]', 'AdminPass123!')
    await page.click('button[type="submit"]')
    
    // ç®¡ç†è€…ã®ç§»ç®¡ç®¡ç†ãƒšãƒ¼ã‚¸ã¸
    await page.goto('/admin/migration')
    
    // ç”³è«‹ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.locator('text=new-parent@example.com')).toBeVisible()
    
    // ç”³è«‹ã‚’æ‰¿èª
    await page.click('button:has-text("æ‰¿èª")')
    await expect(page.locator('text=æ‰¿èªæ¸ˆã¿')).toBeVisible()
    
    // ç§»ç®¡å®Ÿè¡Œ
    await page.click('button:has-text("å®Ÿè¡Œ")')
    await expect(page.locator('text=å®Œäº†')).toBeVisible()
    
    // ç§»ç®¡å¾Œã®ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
    await page.click('button:has-text("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ")')
    await page.goto('/login')
    
    // æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³
    await page.fill('input[name="email"]', 'new-parent@example.com')
    await page.fill('input[name="password"]', 'TestPass123!')
    await page.click('button[type="submit"]')
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page).toHaveURL('/dashboard')
  })
})
```

### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

#### __tests__/performance/auth.test.ts
```typescript
import { performance } from 'perf_hooks'

describe('èªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ', () => {
  test('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“', async () => {
    const iterations = 10
    const times: number[] = []
    
    for (let i = 0; i < iterations; i++) {
      const start = performance.now()
      
      // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      await simulateLogin()
      
      const end = performance.now()
      times.push(end - start)
    }
    
    const averageTime = times.reduce((a, b) => a + b, 0) / times.length
    const maxTime = Math.max(...times)
    
    // å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ500msä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(averageTime).toBeLessThan(500)
    
    // æœ€å¤§ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ1000msä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(maxTime).toBeLessThan(1000)
    
    console.log(`å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${averageTime.toFixed(2)}ms`)
    console.log(`æœ€å¤§ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${maxTime.toFixed(2)}ms`)
  })
})

async function simulateLogin() {
  // å®Ÿéš›ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
  return new Promise(resolve => {
    setTimeout(resolve, Math.random() * 200 + 100)
  })
}
```

## å—ã‘å…¥ã‚ŒåŸºæº–
- [ ] å…¨ã¦ã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šï¼‰
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] E2Eãƒ†ã‚¹ãƒˆã§å…¨ã¦ã®ä¸»è¦ãƒ•ãƒ­ãƒ¼ãŒç¢ºèªã§ãã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã§åŸºæº–å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œãªã„
- [ ] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ãƒ†ã‚¹ãƒˆãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹

## CI/CDçµ±åˆ

### GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test
      
      - name: Run E2E tests
        run: npx playwright test
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: test-results/
```

## é–¢é€£ãƒã‚±ãƒƒãƒˆ
- [01-authentication-setup.md](./01-authentication-setup.md) - èªè¨¼åŸºç›¤ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [05-email-migration.md](./05-email-migration.md) - ãƒ¡ãƒ¼ãƒ«ç§»ç®¡æ©Ÿèƒ½

## æ³¨æ„ç‚¹
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®é©åˆ‡ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿é˜²æ­¢
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒã®åˆ†é›¢
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœã®é©åˆ‡ãªç®¡ç†